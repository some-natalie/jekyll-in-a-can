name: 🔍 Malcontent differential analysis 🔍

on:
  pull_request:
    branches: ["main"]
    types:
      - opened
      - synchronize
      - reopened
    paths:
      - ".github/workflows/**.yml"
      - ".github/workflows/**.yaml"

permissions:
  contents: read

jobs:
  extract-action-repo:
    name: Get repo name from the changed Action
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout the repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get PR diff
        shell: bash
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > pr.diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse action repo and refs
        shell: bash
        run: |
          # Remove diff markers and whitespace, then extract repo and ref
          OLD_USE="${OLD_ACTION_LINE#-}"
          OLD_USE="$(echo "$OLD_USE" | xargs)" # trim whitespace
          OLD_USE="${OLD_USE#uses:}"
          ACTION_REPO="${OLD_USE%@*}"
          OLD_REF="${OLD_USE##*@}"

          NEW_USE="${NEW_ACTION_LINE#+}"
          NEW_USE="$(echo "$NEW_USE" | xargs)"
          NEW_USE="${NEW_USE#uses:}"
          # ACTION_REPO already set above, should be same for old/new line
          NEW_REF="${NEW_USE##*@}"

          echo "ACTION_REPO=$ACTION_REPO" >> "$GITHUB_ENV"
          echo "OLD_REF=$OLD_REF" >> "$GITHUB_ENV"
          echo "NEW_REF=$NEW_REF" >> "$GITHUB_ENV"

      - name: Show extracted variables
        shell: bash
        run: |
          echo "Action repo: $ACTION_REPO"
          echo "Old ref: $OLD_REF"
          echo "New ref: $NEW_REF"

  malcontent:
    name: Malware analysis using malcontent
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      # look at prior state
      - name: Checkout original code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ env.ACTION_REPO }}
          ref: ${{ env.OLD_REF }}
          path: "prior-commit"

      # look at current commit
      - name: Checkout the current code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ env.ACTION_REPO }}
          ref: ${{ env.NEW_REF }}
          path: "current-commit"

      - name: Analyze the files
        id: malcontent
        shell: bash
        run: |
          docker run --rm -v ${{ github.workspace }}:/tmp cgr.dev/chainguard/malcontent:latest --format=markdown diff /tmp/prior-commit /tmp/current-commit >> malcontent-results.md

      - name: Upload results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          path: malcontent-results.md
          name: malcontent-results

  comment:
    name: Comment on the PR
    runs-on: ubuntu-latest
    needs: malcontent
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Download results
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: malcontent-results
          path: .

      - name: Comment on the PR
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const filePath = 'malcontent-results.md';

            if (!fs.existsSync(filePath)) {
              throw new Error(`File not found: ${filePath}`);
            }

            const fileContent = fs.readFileSync(filePath, 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: fileContent,
            });
